<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Contributing to eesyscreener • eesyscreener</title><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Contributing to eesyscreener"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">eesyscreener</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="articles/eesyscreener.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="articles/assumptions_in_checks.html">Assumptions in checks</a></li>
    <li><a class="dropdown-item" href="articles/common_file_failures.html">Common file failures</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/dfe-analytical-services/eesyscreener/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Contributing to eesyscreener</h1>
      <small class="dont-index">Source: <a href="https://github.com/dfe-analytical-services/eesyscreener/blob/main/.github/CONTRIBUTING.md" class="external-link"><code>.github/CONTRIBUTING.md</code></a></small>
    </div>

<div id="contributing-to-eesyscreener" class="section level1">

<p>Ideas for eesyscreener should first be raised as a <a href="https://github.com/dfe-analytical-services/eesyscreener/issues" class="external-link">GitHub issue</a> after which anyone is free to write the code and create a pull request for review.</p>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a></h2>
<p><a href="https://explore-education-statistics.service.gov.uk/" class="external-link">Explore education statistics (EES)</a> is our bespoke statistics publishing platform, for it to work we rely on standardising the structure of our data files.</p>
<p>This package contains the checks used to enforce our <a href="https://dfe-analytical-services.github.io/analysts-guide/statistics-production/ud.html" class="external-link">open data standards</a>.</p>
<p>Before contributing to the package, you should read this, and the vignettes describing the package, to understand all of the logic and decisions made. Particularly the <code>assumptions_in_checks.Rmd</code> vignette as that provides crucial information about interdependencies between functions within the package.</p>
</div>
<div class="section level2">
<h2 id="package-structure">Package structure<a class="anchor" aria-label="anchor" href="#package-structure"></a></h2>
<p>The <code>screen_*()</code> functions are the key user facing exports of the package.</p>
<p><code><a href="reference/screen_csv.html">screen_csv()</a></code> is expected to be the primary function used, it takes a pair of CSV files and screens them.</p>
<ul><li>One script per exported function (except for data objects or if internal and in <code>R/utils.R</code>)</li>
<li>All individual checks should be named in accordance with the naming conventions in the <code>_pkgdown.yml</code> file</li>
<li>Due to the extensive use of check / test in this package, internal functions handling argument validation should follow the <code>validate_arg_*()</code> convention</li>
<li>All <code>check_*()</code> functions must return a consistent list structure</li>
<li>
<code>R/utils.R</code> contains all internal functions</li>
<li>
<code>data-raw/</code> contains the source code for example data and hardcoded variables</li>
<li>Use RDS as the main format for permanent test data (beware it automatically does some cleaning!), make temp CSV files or create a data.frame in code if needed</li>
<li>Think about dependencies between functions - explain any in the <code>assumptions_in_checks.Rmd</code> vignette</li>
</ul></div>
<div class="section level2">
<h2 id="stylistic-preferences">Stylistic preferences<a class="anchor" aria-label="anchor" href="#stylistic-preferences"></a></h2>
<p>This package has a big priority on efficiency, we need to keep it fast so the Shiny app and API endpoint are responsive even with larger files</p>
<ul><li>performance profile and use the fastest available functions</li>
<li>test on large files (5 million rows and above), and prioritise large file performance over small file performance</li>
<li>avoid duplication between functions</li>
<li>don’t validate arguments in individual <code>precheck_*()</code> or <code>check_*()</code> functions</li>
</ul><p>duckplyr seems to be the fastest approach, take the following example code, just aimed at checking if the time_identifier values are valid</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Base R</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">time_identifier</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu">eesyscreener</span><span class="fu">::</span><span class="va"><a href="reference/acceptable_time_ids.html">acceptable_time_ids</a></span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># dplyr / duckplr (methods_overwrite / methods_restore)</span></span>
<span><span class="va">data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">time_identifier</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html" class="external-link">anti_join</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"time_identifier"</span> <span class="op">=</span> <span class="fu">eesyscreener</span><span class="fu">::</span><span class="va"><a href="reference/acceptable_time_ids.html">acceptable_time_ids</a></span><span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="st">"time_identifier"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">time_identifier</span><span class="op">)</span></span></code></pre></div>
<p>Initially the base R looks simpler, less code, so likely faster…</p>
<p>Ran through microbenchmark the results on a ~6 million row data.frame in milliseconds were:</p>
<ul><li>base R ~ 3,231 ms</li>
<li>dplyr ~ 61.6 ms</li>
<li>duckplyr ~ 5.7 ms</li>
</ul><p>For the eesyscreener::example_data, a tiny file, results were different, though as mentioned above, we should prioritise the larger files as that is where the greatest impact is felt:</p>
<ul><li>base R ~ 62.6 microseconds</li>
<li>dplyr ~ 1,865 microseconds</li>
<li>duckplr ~ 4,774 microseconds</li>
</ul><p>If Frederick hadn’t already told us enough times, duck is king. We can write nice readable dplyr code, but utilise the power of the duck. Best of both worlds.</p>
<p>If you have issues with linting and dplyr variables showing no visible binding, follow the <a href="https://cran.r-project.org/web/packages/dplyr/vignettes/in-packages.html" class="external-link">guide to using dplyr in packages</a>.</p>
</div>
<div class="section level2">
<h2 id="process-for-moving-in-functions-from-app">Process for moving in functions from app<a class="anchor" aria-label="anchor" href="#process-for-moving-in-functions-from-app"></a></h2>
<p><a href="https://educationgovuk.sharepoint.com/:x:/r/sites/lveesfa00074/Data%20Insights%20and%20Statistics%20Division/Statistics%20Services%20Unit/Explore%20education%20statistics%20platforms/Screening%20tests%20migration%20tracking.xlsx?d=wdc9cf9ce356b47c6a1d1f11aba8bb96d&amp;csf=1&amp;web=1&amp;e=PSIk6I" class="external-link">Tracking spreadsheet set up in sharepoint</a>, this contains a table of all checks, thoughts on new groupings and notes about the migration (including the progress).</p>
<p>Example of adding a new check available in <a href="">PR XX</a></p>
<p>Other commits showing checks being added:</p>
<ul><li>
<code><a href="reference/precheck_col_req_data.html">precheck_col_req_data()</a></code>, also showing adding the req_data_cols data object - <a href="https://github.com/dfe-analytical-services/eesyscreener/commit/98a84e3e7733e99c0fefc90ddb7d876f793ae780" class="external-link uri">https://github.com/dfe-analytical-services/eesyscreener/commit/98a84e3e7733e99c0fefc90ddb7d876f793ae780</a>
</li>
<li>
<code><a href="reference/precheck_meta_col_name.html">precheck_meta_col_name()</a></code>, simple one that simplifies the original function - <a href="https://github.com/dfe-analytical-services/eesyscreener/commit/7e1908f76d5a14d29363fbba45452da8dba60775" class="external-link uri">https://github.com/dfe-analytical-services/eesyscreener/commit/7e1908f76d5a14d29363fbba45452da8dba60775</a>
</li>
</ul><ol style="list-style-type: decimal"><li><p>Tackle one screening check at a time (unless you can create utility functions that cover multiple repeated checks)</p></li>
<li><p>Set up a new script and test script for the check, copy over the relevant code from <a href="https://github.com/dfe-analytical-services/dfe-published-data-qa" class="external-link uri">https://github.com/dfe-analytical-services/dfe-published-data-qa</a></p></li>
<li><p>Add unit tests for the the function</p></li>
<li><p>Adapt the function so that the input arguments and outputs match existing <code>check_*</code> functions</p></li>
<li><p>Integrate the new <code>check_*</code> into the appropriate <code><a href="reference/screen_dfs.html">screen_dfs()</a></code></p></li>
<li><p>Document the code inheriting documentation from existing functions where possible</p></li>
</ol><p>There will be a lot of functions in this package, so we want to minimise the amount of duplicated code.</p>
<p>Use @inheritParams function_name to copy in param definitions from another</p>
<p>Use <code>#' @inherit check_filename_spaces return</code> to copy the return documentation for functions</p>
<ol start="7" style="list-style-type: decimal"><li>Once setup, review and improve the code</li>
</ol><p>Make sure the tests are passing and you’ve commited before this point to ensure you don’t inadvertently break anything!</p>
<ol style="list-style-type: lower-alpha"><li>Have a look through examples of simplifying the code to see if anything could apply to the function you’re working on, e.g. </li>
</ol><p>Simplifying a check for missing values, where previously it used a pre_check object and sapply - <a href="https://github.com/dfe-analytical-services/eesyscreener/commit/290679711d82529a7d0c54b63cac61ae92a350d8" class="external-link uri">https://github.com/dfe-analytical-services/eesyscreener/commit/290679711d82529a7d0c54b63cac61ae92a350d8</a></p>
<ol start="2" style="list-style-type: lower-alpha"><li><p>Create and use helper functions (if you haven’t already), place any helper functions in <code>R/utils.R</code>, mark as @keywords internal</p></li>
<li><p>Avoid bringing in too many new dependencies, try rewriting in base R where possible</p></li>
<li><p>Use <code>microbenchmark</code> to experiment to find the most efficient approach, look at <code>data.table</code> and <code>duckplyr</code> for speedier alternatives (speed is king here) e.g.</p></li>
</ol><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">eesyscreener</span><span class="fu">::</span><span class="va"><a href="reference/example_data.html">example_data</a></span></span>
<span></span>
<span><span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu">microbenchmark</span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="fu">janitor</span><span class="fu">::</span><span class="fu">remove_empty</span><span class="op">(</span><span class="va">data</span>, which <span class="op">=</span> <span class="st">"rows"</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">data</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">row</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">row</span><span class="op">)</span> <span class="op">|</span> <span class="va">row</span> <span class="op">==</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">|</span> <span class="va">data</span> <span class="op">==</span> <span class="st">""</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  times <span class="op">=</span> <span class="fl">100000</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>In this example, the first line requires the janitor package. It is slightly faster with a mean of 115ms, the second line mean was 184ms, and the third line mean was 121ms, as there’s a minimal amount between 1 and 3, usually we’d go for option 3 to avoid needing to call in the janitor package as a dependency, keeping this package more lightweight.</p>
<p>However, when testing with a bigger file (~6million rows), the 2nd and 3rd options were so slow to run that microbenchmark was taking too long to produce a result. Clearly using janitor in option 1 has a massive impact when there’s more rows, so the decision was made to import the janitor package as the speed benefit was worth the extra dependency.</p>
<p>You can use the <code>tests/utils/benchmarking.R</code> script as a starting point, it includes code to generate big tables and run benchmarking. Sometimes the fastest on small files will not be the fastest on bigger ones. Prioritise the bigger files as that’s where the biggest impact will be felt.</p>
<p>If it’s a particularly big function running over a whole data file, also consider using <code>future.apply</code> or other parallel processing approaches if they swap in easily.</p>
<p>TODO: At the end of the migration, we should then plan how to migrate the test data over, so that all of the existing edge cases tested in the R Shiny app can be covered here.</p>
<ol style="list-style-type: lower-alpha"><li><p>Make use of the <code>tests/utils/copy_check_data.R</code> script to copy over CSVs from the screener repo and save as RDS files in the tests folder</p></li>
<li><p>There should be a collection of unit tests and at least one example data file with an expected failure for every function</p></li>
</ol></div>
<div class="section level2">
<h2 id="other-things-to-add-to-the-package">Other things to add to the package<a class="anchor" aria-label="anchor" href="#other-things-to-add-to-the-package"></a></h2>
<p>TODO: Add trello card workflow</p>
</div>
<div class="section level2">
<h2 id="list-of-notes-for-the-main-screener-when-migrating-over">List of notes for the main screener when migrating over<a class="anchor" aria-label="anchor" href="#list-of-notes-for-the-main-screener-when-migrating-over"></a></h2>
<p>TODO: Move the images out of screenFiles and into the server part of the app</p>
<p>TODO: Move the character forcing of columns to within the screen files function</p>
<p>TODO: Update the test data and testing approach</p>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Cam Race.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

